import time

def clicar_botao_shadow_dom(driver, atributo, valor, seletor_interno='button', timeout=10, descricao=None):
    """
    Fun√ß√£o para clicar em bot√µes dentro de Shadow DOM ANINHADO
    
    Args:
        driver: Inst√¢ncia do Selenium WebDriver
        atributo: Atributo do elemento host (ex: 'part', 'title', 'caption')
        valor: Valor do atributo (ex: 'btn-ok', 'Bot√£o confirmar')
        seletor_interno: Seletor CSS do elemento interno (padr√£o: 'button')
        timeout: Tempo m√°ximo de espera
        descricao: Descri√ß√£o para logs
    
    Exemplos:
        clicar_botao_shadow_dom(driver, 'part', 'btn-ok')
        clicar_botao_shadow_dom(driver, 'caption', 'Ok')
        clicar_botao_shadow_dom(driver, 'title', 'Bot√£o confirmar')
    """
    try:
        desc = descricao or f"{atributo}='{valor}'"
        print(f"üîç Procurando bot√£o Shadow DOM ({desc})...")
        
        time.sleep(1)
        
        # Script JavaScript que lida com Shadow DOM ANINHADO (recursivo)
        script = f"""
            // Fun√ß√£o recursiva para buscar em shadow DOM aninhado
            function findInShadowDOM(root, attribute, value) {{
                // Buscar em todos os elementos do root atual
                var elements = root.querySelectorAll('*');
                
                for (var i = 0; i < elements.length; i++) {{
                    var el = elements[i];
                    
                    // Verificar se o elemento corresponde ao atributo
                    var attrValue = el.getAttribute(attribute);
                    if (attrValue === value || (attrValue && attrValue.includes(value))) {{
                        console.log('‚úì Elemento encontrado:', el.tagName, attrValue);
                        return el;
                    }}
                    
                    // Se tem shadowRoot, buscar recursivamente DENTRO dele
                    if (el.shadowRoot) {{
                        var found = findInShadowDOM(el.shadowRoot, attribute, value);
                        if (found) return found;
                    }}
                }}
                
                return null;
            }}
            
            // Buscar em toda a p√°gina (incluindo shadows aninhados)
            var targetElement = findInShadowDOM(document, '{atributo}', '{valor}');
            
            if (!targetElement) {{
                console.error('‚ùå Elemento n√£o encontrado');
                return {{success: false, found: false}};
            }}
            
            console.log('üéØ Elemento alvo encontrado:', targetElement.tagName);
            
            // Se o elemento tem shadowRoot, buscar o button interno
            if (targetElement.shadowRoot) {{
                var innerBtn = targetElement.shadowRoot.querySelector('{seletor_interno}');
                
                if (innerBtn) {{
                    console.log('‚úì Bot√£o interno encontrado, clicando...');
                    innerBtn.click();
                    return {{success: true, found: true, method: 'inner_button'}};
                }} else {{
                    console.log('‚ö†Ô∏è Bot√£o interno n√£o encontrado, clicando no host');
                    targetElement.click();
                    return {{success: true, found: true, method: 'host_click'}};
                }}
            }} else {{
                console.log('‚úì Clicando diretamente no elemento');
                targetElement.click();
                return {{success: true, found: true, method: 'direct_click'}};
            }}
        """
        
        resultado = driver.execute_script(script)
        
        if resultado.get('success'):
            metodo = resultado.get('method', 'unknown')
            print(f"‚úÖ Bot√£o clicado! (m√©todo: {metodo}) - {desc}")
            time.sleep(0.5)
            return True
        else:
            print(f"‚ùå Bot√£o n√£o encontrado - {desc}")
            return False
            
    except Exception as e:
        print(f"‚ùå Erro ao clicar no bot√£o Shadow DOM ({desc}): {e}")
        import traceback
        traceback.print_exc()
        return False
