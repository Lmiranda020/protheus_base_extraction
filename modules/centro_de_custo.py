import time
from datetime import datetime, timedelta
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from config.list_filial import LISTA_FILIAIS
from modules.clicar_botao_shadow_dom import clicar_botao_shadow_dom
from modules.clicar_menu_item_direto import clicar_menu_item_direto
from modules.clicar_botao_shadow_por_texto import clicar_botao_shadow_por_texto
from modules.clicar_input_shadow import clicar_input_shadow, preencher_input_shadow


def automation_centro_de_custo (competencia, driver):
    """
    Automatiza o download do relat√≥rio de centro de custo
    """
    print("=" * 60)
    print("üöÄ INICIANDO AUTOMA√á√ÉO DE CENTRO DE CUSTO")
    print("=" * 60)
    
    # Clicar no menu "Cadastros"
    if clicar_menu_item_direto(driver, menu_id="COMP3009"):
        print("‚úÖ Clicado em Cadastros atrav√©s do bot√£o!")
        time.sleep(2)

    for filial in LISTA_FILIAIS:
        print(f"üè¢ Processando filial: {filial}")
    
        # Clicar no bot√£o "Centro de Custo"
        if clicar_menu_item_direto(driver, menu_id="COMP3091"):
                print("‚úÖ Clicado em Centro de Custo atrav√©s do bot√£o!")
                time.sleep(2)
        
        # Navegar pelos campos (2 tabs)
        webdriver.ActionChains(driver).send_keys(Keys.TAB).perform()
        time.sleep(1)
        webdriver.ActionChains(driver).send_keys(Keys.TAB).perform()
        time.sleep(2)

        # Apagar o campo selecionado
        webdriver.ActionChains(driver).send_keys(Keys.BACKSPACE).perform()

        # Digitar a filial
        webdriver.ActionChains(driver).send_keys(filial).perform()
        time.sleep(2)

        # Clicar no bot√£o "Confirmar"
        # M√©todo 1: Por id
        if clicar_botao_shadow_dom(driver, 'id', 'COMP4522',seletor_interno='button', descricao="Confirmar"):
            print("‚úÖ Clicado em Confirmar atrav√©s do bot√£o!")
            time.sleep(2)
        # M√©todo 2: Por caption
        else: 
            clicar_botao_shadow_por_texto(driver, 'Confirmar')
            print("‚úÖ Clicado em Confirmar atrav√©s do texto!")
            time.sleep(2)

        time.sleep(8)

        # Selecionar a op√ß√£o "Planilha"
        if clicar_botao_shadow_dom(driver, 'id', 'COMP4528',seletor_interno='button', descricao="Planilha"):
            print("‚úÖ Clicado em Planilha atrav√©s do bot√£o!")
            time.sleep(2)
        else: 
            clicar_botao_shadow_por_texto(driver, 'Planilha')
            print("‚úÖ Clicado em Planilha atrav√©s do texto!")
            time.sleep(2)

        
        # Criar o nome do arquivo
        nome_arquivo = f"CENTRO_DE_CUSTO_{filial}_{competencia}.xlsx"

        # # Debug completo
        # resultados = debug_estrutura_completa(driver)

        # # Tamb√©m tente buscar por texto pr√≥ximo (ex: "Impress√£o", "Arquivo", etc.)
        # buscar_elemento_por_vizinhos(driver, "impress√£o")
        # buscar_elemento_por_vizinhos(driver, "arquivo")
        # buscar_elemento_por_vizinhos(driver, "nome")

        # input("\n‚è∏Ô∏è  Pressione Enter para continuar ap√≥s revisar o debug...")

        time.sleep(5)

        # Focar no campo de impress√£o
        print("\nüìù Focando no campo de impress√£o...")
        if not clicar_input_shadow(driver, 'COMP4539', debug=True): 
            print("‚ö†Ô∏è N√£o conseguiu focar no campo COMP4539, tentando alternativa...")
            # Alternativa: usar TABs
            webdriver.ActionChains(driver).send_keys(Keys.TAB).perform()
            time.sleep(1)
        
        time.sleep(2)

        # Selecionar todo o texto do campo
        print("üìã Selecionando todo o texto...")
        webdriver.ActionChains(driver).key_down(Keys.CONTROL).send_keys('a').key_up(Keys.CONTROL).perform()
        time.sleep(1)
        
        # Apagar o texto
        print("üóëÔ∏è Apagando texto...")
        webdriver.ActionChains(driver).send_keys(Keys.BACKSPACE).perform()
        time.sleep(1)
        
        # Preencher com o nome do arquivo
        print(f"‚úçÔ∏è Preenchendo com: {nome_arquivo}")
        webdriver.ActionChains(driver).send_keys(nome_arquivo).perform()
        time.sleep(2)

        # OU usar a fun√ß√£o direta (escolha uma das duas abordagens):
        # if preencher_input_shadow(driver, 'COMP4539', nome_arquivo, limpar_antes=True):
        #     print("‚úÖ Campo preenchido com sucesso!")
        # else:
        #     print("‚ö†Ô∏è Falha ao preencher, usando ActionChains...")
        #     webdriver.ActionChains(driver).send_keys(nome_arquivo).perform()
        
        # clicar no bot√£o imprimir
        
        # Preparar o caminho completo
        ano = competencia[:4]
        mes = competencia[4:6]
        caminho_fixo = "Y:\\CONTROLADORIA\\CUSTOS\\15_BASES_PROTHEUS\\Centro de Custo"
        caminho_fixo_completo = f"{caminho_fixo}\\{ano}\\{mes}_{ano}"

        print(f"üìÇ Caminho: {caminho_fixo_completo}")

        # Navegar para o campo de servidor (provavelmente o pr√≥ximo TAB)
        print("\nüìÅ Focando no campo servidor...")
        webdriver.ActionChains(driver).send_keys(Keys.TAB).perform()
        time.sleep(1)

        # Selecionar tudo e apagar
        webdriver.ActionChains(driver).key_down(Keys.CONTROL).send_keys('a').key_up(Keys.CONTROL).perform()
        time.sleep(1)
        webdriver.ActionChains(driver).send_keys(Keys.BACKSPACE).perform()
        time.sleep(1)
        
        # Preencher o caminho
        print(f"‚úçÔ∏è Preenchendo caminho...")
        webdriver.ActionChains(driver).send_keys(caminho_fixo_completo).perform()
        time.sleep(2)
        
        # TODO: Clicar no bot√£o "Imprimir" ou "OK" para finalizar
        # Voc√™ precisa identificar o ID do bot√£o de impress√£o
        print("\nüñ®Ô∏è Clicando no bot√£o de impress√£o...")
        # if clicar_botao_shadow_dom(driver, 'id', 'COMP4XXX', seletor_interno='button', descricao="Imprimir"):
        #     print("‚úÖ Download iniciado!")
        # else:
        #     clicar_botao_shadow_por_texto(driver, 'Imprimir')
        
        print(f"‚úÖ Filial {filial} processada!")
        time.sleep(3)

    time.sleep(10)
    print("‚úì Download conclu√≠do (aguardando valida√ß√£o e organiza√ß√£o)")

    print("=" * 60)
    print("‚úì AUTOMA√á√ÉO DE CENTRO DE CUSTO CONCLU√çDA COM SUCESSO!")