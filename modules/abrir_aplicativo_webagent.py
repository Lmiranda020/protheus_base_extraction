import subprocess
import time
import psutil
import os

def abrir_aplicativo_webagent(caminho_app, timeout=30):
    """
    Abre o aplicativo WebAgent em segundo plano
    
    Args:
        caminho_app: Caminho completo do execut√°vel
        timeout: Tempo m√°ximo para aguardar o app iniciar (segundos)
    
    Returns:
        bool: True se abriu com sucesso, False caso contr√°rio
    """
    print("\nüöÄ Abrindo aplicativo WebAgent...")
    
    try:
        # Verificar se o aplicativo j√° est√° rodando
        nome_processo = os.path.basename(caminho_app)
        for proc in psutil.process_iter(['name']):
            if proc.info['name'] == nome_processo:
                print(f"‚úÖ Aplicativo j√° est√° rodando (PID: {proc.pid})")
                return True
        
        # Abrir o aplicativo em segundo plano
        # Use CREATE_NO_WINDOW no Windows para n√£o mostrar janela
        if os.name == 'nt':  # Windows
            startupinfo = subprocess.STARTUPINFO()
            startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW
            startupinfo.wShowWindow = 0  # SW_HIDE
            
            processo = subprocess.Popen(
                [caminho_app],
                startupinfo=startupinfo,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
        else:  # Linux/Mac
            processo = subprocess.Popen(
                [caminho_app],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
        
        print(f"‚úÖ Aplicativo iniciado (PID: {processo.pid})")
        
        # Aguardar o app inicializar completamente
        print(f"‚è≥ Aguardando {timeout}s para o aplicativo inicializar...")
        time.sleep(timeout)
        
        # Verificar se o processo ainda est√° rodando
        if processo.poll() is None:
            print("‚úÖ Aplicativo rodando em segundo plano!")
            return True
        else:
            print("‚ùå Aplicativo foi fechado inesperadamente")
            return False
            
    except FileNotFoundError:
        print(f"‚ùå Aplicativo n√£o encontrado em: {caminho_app}")
        return False
    except Exception as e:
        print(f"‚ùå Erro ao abrir aplicativo: {e}")
        return False