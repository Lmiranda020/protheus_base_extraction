def debug_estrutura_completa(driver):
    """
    Faz um debug completo da estrutura Shadow DOM, incluindo iframes
    """
    print("\n" + "="*80)
    print("üîç DEBUG COMPLETO DA ESTRUTURA")
    print("="*80)
    
    script = """
        function debugCompleto() {
            let resultados = {
                shadowRoots: [],
                iframes: [],
                waInputs: [],
                elementosComId: []
            };
            
            function analisarElemento(root, caminho = 'document', nivel = 0) {
                if (nivel > 10) return;
                
                let indent = '  '.repeat(nivel);
                
                // 1. Buscar todos os elementos com ID que come√ßam com 'COMP'
                let compElements = root.querySelectorAll('[id^="COMP"]');
                compElements.forEach(el => {
                    let info = {
                        id: el.id,
                        tagName: el.tagName.toLowerCase(),
                        caminho: caminho,
                        temShadow: !!el.shadowRoot,
                        atributos: {}
                    };
                    
                    ['label', 'placeholder', 'caption', 'type', 'value'].forEach(attr => {
                        if (el.hasAttribute(attr)) {
                            info.atributos[attr] = el.getAttribute(attr);
                        }
                    });
                    
                    resultados.elementosComId.push(info);
                });
                
                // 2. Buscar wa-input e wa-text-input
                let waInputs = root.querySelectorAll('wa-input, wa-text-input');
                waInputs.forEach(el => {
                    let info = {
                        id: el.id || 'sem-id',
                        tagName: el.tagName.toLowerCase(),
                        label: el.getAttribute('label') || '',
                        placeholder: el.getAttribute('placeholder') || '',
                        caminho: caminho,
                        temShadow: !!el.shadowRoot
                    };
                    
                    if (el.shadowRoot) {
                        let inputInterno = el.shadowRoot.querySelector('input, textarea');
                        if (inputInterno) {
                            info.inputInterno = {
                                type: inputInterno.type || inputInterno.tagName.toLowerCase(),
                                value: inputInterno.value || '',
                                placeholder: inputInterno.placeholder || ''
                            };
                        }
                    }
                    
                    resultados.waInputs.push(info);
                });
                
                // 3. Analisar iframes
                let iframes = root.querySelectorAll('iframe');
                iframes.forEach((iframe, idx) => {
                    let info = {
                        id: iframe.id || `iframe-${idx}`,
                        src: iframe.src || 'about:blank',
                        caminho: caminho,
                        acessivel: false
                    };
                    
                    try {
                        if (iframe.contentDocument) {
                            info.acessivel = true;
                            info.title = iframe.contentDocument.title;
                            analisarElemento(
                                iframe.contentDocument, 
                                caminho + ` > iframe#${info.id}`, 
                                nivel + 1
                            );
                        }
                    } catch (e) {
                        info.erro = e.toString();
                    }
                    
                    resultados.iframes.push(info);
                });
                
                // 4. Buscar em Shadow DOM
                let todosElementos = root.querySelectorAll('*');
                for (let el of todosElementos) {
                    if (el.shadowRoot) {
                        let tagName = el.tagName.toLowerCase();
                        let elId = el.id ? '#' + el.id : '';
                        
                        resultados.shadowRoots.push({
                            elemento: tagName + elId,
                            caminho: caminho
                        });
                        
                        analisarElemento(
                            el.shadowRoot, 
                            caminho + ` > ${tagName}${elId} (shadow)`, 
                            nivel + 1
                        );
                    }
                }
            }
            
            analisarElemento(document);
            return resultados;
        }
        
        return debugCompleto();
    """
    
    try:
        resultados = driver.execute_script(script)
        
        # Exibir Shadow Roots
        print("\nüåë SHADOW ROOTS ENCONTRADOS:")
        if resultados['shadowRoots']:
            for sr in resultados['shadowRoots']:
                print(f"  ‚Ä¢ {sr['elemento']}")
                print(f"    üìç {sr['caminho']}")
        else:
            print("  ‚ùå Nenhum Shadow Root encontrado")
        
        # Exibir iframes
        print("\nüñºÔ∏è  IFRAMES ENCONTRADOS:")
        if resultados['iframes']:
            for iframe in resultados['iframes']:
                print(f"  ‚Ä¢ {iframe['id']}")
                print(f"    üìç {iframe['caminho']}")
                print(f"    üîó src: {iframe['src'][:80]}...")
                print(f"    ‚úì Acess√≠vel: {iframe['acessivel']}")
                if 'title' in iframe:
                    print(f"    üìÑ T√≠tulo: {iframe['title']}")
                if 'erro' in iframe:
                    print(f"    ‚ùå Erro: {iframe['erro']}")
        else:
            print("  ‚ùå Nenhum iframe encontrado")
        
        # Exibir wa-inputs
        print("\nüìù WA-INPUTS ENCONTRADOS:")
        if resultados['waInputs']:
            for inp in resultados['waInputs']:
                print(f"  ‚Ä¢ ID: {inp['id']} <{inp['tagName']}>")
                print(f"    Label: {inp['label']}")
                print(f"    Placeholder: {inp['placeholder']}")
                print(f"    üìç {inp['caminho']}")
                print(f"    Shadow: {inp['temShadow']}")
                if 'inputInterno' in inp:
                    print(f"    ‚ûú Input interno: {inp['inputInterno']['type']}")
                    print(f"      Valor: '{inp['inputInterno']['value']}'")
        else:
            print("  ‚ùå Nenhum wa-input encontrado")
        
        # Exibir elementos com ID COMP*
        print("\nüÜî ELEMENTOS COM ID 'COMP*':")
        if resultados['elementosComId']:
            comp4539_proximos = [
                el for el in resultados['elementosComId'] 
                if abs(int(el['id'].replace('COMP', '')) - 4539) < 20
            ]
            
            if comp4539_proximos:
                print("\n  üìç ELEMENTOS PR√ìXIMOS A COMP4539:")
                for el in sorted(comp4539_proximos, key=lambda x: x['id']):
                    print(f"  ‚Ä¢ {el['id']} <{el['tagName']}>")
                    print(f"    üìç {el['caminho']}")
                    print(f"    Shadow: {el['temShadow']}")
                    if el['atributos']:
                        print(f"    Atributos: {el['atributos']}")
            
            comp4539 = next((el for el in resultados['elementosComId'] if el['id'] == 'COMP4539'), None)
            if comp4539:
                print("\n  üéØ ENCONTRADO COMP4539!")
                print(f"  ‚Ä¢ Tag: {comp4539['tagName']}")
                print(f"  ‚Ä¢ Caminho: {comp4539['caminho']}")
                print(f"  ‚Ä¢ Shadow: {comp4539['temShadow']}")
                print(f"  ‚Ä¢ Atributos: {comp4539['atributos']}")
            else:
                print("\n  ‚ùå COMP4539 N√ÉO ENCONTRADO!")
        else:
            print("  ‚ùå Nenhum elemento com ID 'COMP*' encontrado")
        
        print("\n" + "="*80)
        
        return resultados
        
    except Exception as e:
        print(f"\n‚ùå Erro no debug: {e}")
        import traceback
        traceback.print_exc()
        return None


def buscar_elemento_por_vizinhos(driver, texto_label_proximo):
    """
    Tenta encontrar um input baseado em um label ou texto pr√≥ximo
    """
    print(f"\nüîç Buscando input pr√≥ximo ao texto '{texto_label_proximo}'...")
    
    script = f"""
        function buscarPorVizinho() {{
            function buscarEmRoot(root, caminho = 'document') {{
                let walker = document.createTreeWalker(
                    root,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let results = [];
                let node;
                
                while (node = walker.nextNode()) {{
                    if (node.textContent.toLowerCase().includes('{texto_label_proximo}'.toLowerCase())) {{
                        let parent = node.parentElement;
                        
                        let inputs = [];
                        
                        if (parent.parentElement) {{
                            inputs = inputs.concat(
                                Array.from(parent.parentElement.querySelectorAll('input, textarea, wa-input, wa-text-input'))
                            );
                        }}
                        
                        results.push({{
                            texto: node.textContent.trim(),
                            caminho: caminho,
                            parentTag: parent.tagName.toLowerCase(),
                            parentId: parent.id || 'sem-id',
                            inputsProximos: inputs.map(inp => ({{
                                tag: inp.tagName.toLowerCase(),
                                id: inp.id || 'sem-id',
                                type: inp.type || 'N/A'
                            }}))
                        }});
                    }}
                }}
                
                let all = root.querySelectorAll('*');
                for (let el of all) {{
                    if (el.shadowRoot) {{
                        let tagName = el.tagName.toLowerCase();
                        let elId = el.id ? '#' + el.id : '';
                        results = results.concat(
                            buscarEmRoot(el.shadowRoot, caminho + ` > ${{tagName}}${{elId}} (shadow)`)
                        );
                    }}
                }}
                
                return results;
            }}
            
            return buscarEmRoot(document);
        }}
        
        return buscarPorVizinho();
    """
    
    try:
        resultados = driver.execute_script(script)
        
        if resultados:
            print(f"\n‚úÖ Encontrados {len(resultados)} elementos com o texto:")
            for i, res in enumerate(resultados, 1):
                print(f"\n  [{i}] Texto: '{res['texto'][:50]}...'")
                print(f"      Parent: <{res['parentTag']}> id='{res['parentId']}'")
                print(f"      Caminho: {res['caminho']}")
                if res['inputsProximos']:
                    print(f"      Inputs pr√≥ximos:")
                    for inp in res['inputsProximos']:
                        print(f"        ‚Ä¢ <{inp['tag']}> id='{inp['id']}' type='{inp['type']}'")
        else:
            print(f"‚ùå Nenhum elemento encontrado com o texto '{texto_label_proximo}'")
        
        return resultados
        
    except Exception as e:
        print(f"‚ùå Erro: {e}")
        return None