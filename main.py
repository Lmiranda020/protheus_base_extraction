import time
from modules.centro_de_custo import automation_centro_de_custo
from auth.login_manager import autenticar, url_sistema
from modules.calcular_competencia import calcular_competencia
from config.config_driver import setup_driver
from modules.clicar_botao_shadow_dom import clicar_botao_shadow_dom
from auth.fazer_login import fazer_login_selenium
from modules.clicar_botao_shadow_por_texto import clicar_botao_shadow_por_texto
from modules.clicar_botao_shadow_duplo_iframe import clicar_botao_shadow_duplo_iframe
from modules.tirar_screenshot import tirar_screenshot

if __name__ == "__main__":
    
    print("=" * 60)
    print("üöÄ INICIANDO AUTOMA√á√ÉO SELENIUM - SHADOW DOM ANINHADO")
    print("=" * 60)
    
    # Carregar credenciais
    NOME_APP, EMAIL, SENHA, TITULO_JANELA = autenticar()

    URL_APP = url_sistema()
    
    driver = None
    
    try:
        # 1. Configurar driver
        print("‚öôÔ∏è Configurando driver...")
        driver = setup_driver(headless=False)  # False para ver o que est√° acontecendo
        
        # 2. Navegar para a aplica√ß√£o
        driver.get(URL_APP)
        time.sleep(3)
        
        # # 3. DEBUG: Listar todos os bot√µes Shadow DOM (DESCOMENTE PARA DEBUG)
        # print("\nüîç Listando todos os componentes Shadow DOM...")
        # listar_botoes_shadow_dom(driver)
        
        # 4. Clicar no bot√£o OK no Shadow DOM aninhado (ANTES do login)
        print("\nüîò Clicando no bot√£o OK (Shadow DOM aninhado)...")
        
        # M√©todo 1: Por atributo 'part'
        if clicar_botao_shadow_dom(driver, 'part', 'btn-ok', descricao="Bot√£o OK via part"):
            time.sleep(2)
        # M√©todo 2: Por caption
        elif clicar_botao_shadow_dom(driver, 'caption', 'Ok', descricao="Bot√£o OK via caption"):
            time.sleep(2)
        # M√©todo 3: Por texto vis√≠vel
        elif clicar_botao_shadow_por_texto(driver, 'Ok'):
            time.sleep(2)
        else:
            print("‚ö†Ô∏è Bot√£o OK n√£o encontrado, continuando...")
            # se n'ao encontrar parar o processo
            raise Exception("Bot√£o OK n√£o encontrado")
    
        time.sleep(5)
        
        # 5. Fazer login
        if not fazer_login_selenium(driver, EMAIL, SENHA, URL_APP):
            raise Exception("Falha no login")
        
        # 6. Aguardar p√°gina carregar
        time.sleep(3)

        # 7. Calcular compet√™ncia
        competencia = calcular_competencia()
        print(f"üìÖ Compet√™ncia: {competencia}")

        # 8. Aguardar webview e iframe carregarem
        print("\n‚è≥ Aguardando webview e iframe carregarem...")
        time.sleep(5)  # IMPORTANTE: dar tempo para o iframe renderizar

        # 9. Clicar no bot√£o Entrar (Shadow duplo + iframe)
        print("\nüîò Clicando no bot√£o Entrar...")

        if clicar_botao_shadow_duplo_iframe(driver, webview_id='COMP3010', texto_botao='Entrar'):
            print("‚úì Processo conclu√≠do! Avan√ßando para pr√≥xima etapa...")
            time.sleep(3)
        else:
            print("\n‚ö†Ô∏è BOT√ÉO N√ÉO ENCONTRADO!")
            print("üì∏ Tirando screenshot para debug...")
            tirar_screenshot(driver, "erro_botao_entrar.png")
            
            # Tentar listar o que tem no iframe
            print("\nüîç Listando conte√∫do do iframe para debug...")
            debug_script = """
                var webview = document.getElementById('COMP3010');
                if (!webview || !webview.shadowRoot) return {error: 'webview n√£o encontrado'};
                
                var iframe = webview.shadowRoot.querySelector('iframe');
                if (!iframe) {
                    // Tentar em shadow aninhado
                    var els = webview.shadowRoot.querySelectorAll('*');
                    for (var i = 0; i < els.length; i++) {
                        if (els[i].shadowRoot) {
                            iframe = els[i].shadowRoot.querySelector('iframe');
                            if (iframe) break;
                        }
                    }
                }
                
                if (!iframe) return {error: 'iframe n√£o encontrado'};
                
                var doc = iframe.contentDocument;
                if (!doc) return {error: 'documento inacess√≠vel'};
                
                return {
                    title: doc.title,
                    buttons: Array.from(doc.querySelectorAll('button')).map(b => b.textContent.trim()),
                    inputs: Array.from(doc.querySelectorAll('input[type="submit"], input[type="button"]')).map(i => i.value)
                };
            """
            
            info = driver.execute_script(debug_script)
            print(f"üìÑ Info do iframe: {info}")
            
            raise Exception("Bot√£o Entrar n√£o encontrado")
        
        # 10. Chamar automa√ß√£o de centro de custo
        print("üè¢ Iniciando automa√ß√£o de centro de custo...")
        automation_centro_de_custo(competencia, driver=driver)
        
        print("\n" + "=" * 60)
        print("‚úÖ AUTOMA√á√ÉO CONCLU√çDA COM SUCESSO!")
        print("=" * 60)
        
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Automa√ß√£o cancelada pelo usu√°rio")
    except Exception as e:
        print(f"\n‚ùå Erro: {e}")
        import traceback
        traceback.print_exc()
        
        if driver:
            tirar_screenshot(driver, "erro_screenshot.png")
    
    finally:
        if driver:
            print("\nüîö Fechando driver...")
            driver.quit()
    
    input("\nPressione Enter para finalizar...")